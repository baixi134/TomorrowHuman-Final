{% extends 'web/base.html' %}
{% load static %}
{% block title %}èµ›åšæœ‹å…‹è™šæ‹Ÿå¹¿åœº{% endblock %}

{% block content %}
  <!-- å·¦ä¾§å¯ä¼¸ç¼©ä¾§è¾¹æ  -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="åˆ‡æ¢ä¾§è¾¹æ ">
      <span class="toggle-icon">â—€</span>
    </button>
    <div class="sidebar-content">
      <a href="{% url 'web:tree_index' %}" class="sidebar-item" title="æ•°æ®ä¸­å¿ƒ">
        <span class="sidebar-icon">ğŸ§ </span>
        <span class="sidebar-text">æ•°æ®ä¸­å¿ƒ</span>
      </a>
      <a href="{% url 'web:shop' %}" class="sidebar-item" title="é»‘å¸‚">
        <span class="sidebar-icon">ğŸ›’</span>
        <span class="sidebar-text">é»‘å¸‚</span>
      </a>
      <a href="{% url 'web:profile' %}" class="sidebar-item" title="å®‰å…¨å±‹">
        <span class="sidebar-icon">ğŸ </span>
        <span class="sidebar-text">å®‰å…¨å±‹</span>
      </a>
      <a href="{% url 'web:ai_assistant' %}" class="sidebar-item" title="AIåŠ©æ‰‹">
        <span class="sidebar-icon">ğŸ¤–</span>
        <span class="sidebar-text">AIåŠ©æ‰‹</span>
      </a>
    </div>
  </div>

  <div class="city-stage">
    {% for user_obj in latest_users %}
      {% with profile=user_obj.profile %}
        <div 
          class="citizen" 
          data-user-id="{{ user_obj.id }}"
          data-username="{{ user_obj.username }}"
          data-nickname="{{ profile.nickname|default:user_obj.username }}"
          data-avatar-url="{% if profile.avatar %}{{ profile.avatar.url }}{% else %}{% endif %}"
          data-level="{{ profile.level|default:1 }}"
          {% if user.is_authenticated %}data-is-current-user="{% if user_obj.id == user.id %}true{% else %}false{% endif %}"{% else %}data-is-current-user="false"{% endif %}
        >
          {% if profile.avatar %}
            <img
              src="{{ profile.avatar.url }}"
              alt="{{ profile.nickname|default:user_obj.username }}"
              class="citizen-avatar"
            >
          {% else %}
            <div class="citizen-avatar citizen-avatar-placeholder">
              {{ user_obj.username|first|upper }}
            </div>
          {% endif %}
          <div class="citizen-tooltip">
            {{ profile.nickname|default:user_obj.username }} | Lv.{{ profile.level|default:1 }}
          </div>
        </div>
      {% endwith %}
    {% endfor %}

    {% for plot in plots %}
      <div 
        class="land-plot {% if plot.owner %}land-plot-owned{% else %}land-plot-available{% endif %}"
        data-id="{{ plot.id }}"
        data-price="{{ plot.price }}"
        data-name="{{ plot.name }}"
        data-owner-id="{% if plot.owner %}{{ plot.owner.id }}{% endif %}"
        data-owner-name="{% if plot.owner %}{{ plot.owner.profile.nickname|default:plot.owner.username }}{% endif %}"
        data-is-mine="{% if plot.owner and current_user_id and plot.owner.id == current_user_id %}yes{% else %}no{% endif %}"
        style="left: {{ plot.x_pos|default:0 }}%; top: {{ plot.y_pos|default:0 }}%; z-index: {{ plot.y_pos|default:0 }};"
      >
        {% if plot.owner %}
          <img 
            src="{% static 'web/images/plot_building.png' %}" 
            alt="{{ plot.name }}"
            class="land-plot-image"
          >
        {% else %}
          <img 
            src="{% static 'web/images/plot_empty.png' %}" 
            alt="{{ plot.name }}"
            class="land-plot-image land-plot-empty"
          >
        {% endif %}
        <div class="land-plot-tooltip">{{ plot.name }}</div>
      </div>
    {% endfor %}

  </div>

  <style>
    /* ä¾§è¾¹æ æ ·å¼ */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      width: 200px;
      background: rgba(22, 33, 62, 0.95);
      backdrop-filter: blur(10px);
      border-right: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 
        2px 0 20px rgba(0, 255, 255, 0.2),
        inset -2px 0 20px rgba(157, 78, 221, 0.1);
      z-index: 1000;
      transition: transform 0.3s ease, width 0.3s ease;
      display: flex;
      flex-direction: column;
      padding-top: 80px;
    }

    .sidebar.collapsed {
      width: 60px;
    }

    .sidebar-toggle {
      position: absolute;
      top: 20px;
      right: -15px;
      width: 30px;
      height: 30px;
      background: rgba(22, 33, 62, 0.95);
      border: 2px solid rgba(0, 255, 255, 0.5);
      border-radius: 50%;
      color: #00ffff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 
        0 0 10px rgba(0, 255, 255, 0.3),
        inset 0 0 10px rgba(0, 255, 255, 0.1);
      z-index: 1001;
    }

    .sidebar-toggle:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 
        0 0 15px rgba(0, 255, 255, 0.5),
        inset 0 0 15px rgba(0, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .toggle-icon {
      font-size: 14px;
      transition: transform 0.3s ease;
      display: inline-block;
    }

    .sidebar.collapsed .toggle-icon {
      transform: rotate(180deg);
    }

    .sidebar-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
      padding: 20px 15px;
      overflow-y: auto;
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      text-decoration: none;
      color: #e0e0e0;
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .sidebar-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 3px;
      height: 100%;
      background: transparent;
      transition: all 0.3s ease;
    }

    .sidebar-item:hover {
      background: rgba(0, 255, 255, 0.1);
      border-color: rgba(0, 255, 255, 0.5);
      transform: translateX(5px);
      box-shadow: 
        0 0 15px rgba(0, 255, 255, 0.3),
        inset 0 0 15px rgba(0, 255, 255, 0.05);
    }

    .sidebar-item:hover::before {
      background: #00ffff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
    }

    .sidebar-item:nth-child(1):hover {
      border-color: rgba(0, 255, 255, 0.5);
      box-shadow: 
        0 0 15px rgba(0, 255, 255, 0.3),
        inset 0 0 15px rgba(0, 255, 255, 0.05);
    }

    .sidebar-item:nth-child(1):hover::before {
      background: #00ffff;
    }

    .sidebar-item:nth-child(2):hover {
      border-color: rgba(157, 78, 221, 0.5);
      box-shadow: 
        0 0 15px rgba(157, 78, 221, 0.3),
        inset 0 0 15px rgba(157, 78, 221, 0.05);
    }

    .sidebar-item:nth-child(2):hover::before {
      background: #9d4edd;
    }

    .sidebar-item:nth-child(3):hover {
      border-color: rgba(255, 215, 0, 0.5);
      box-shadow: 
        0 0 15px rgba(255, 215, 0, 0.3),
        inset 0 0 15px rgba(255, 215, 0, 0.05);
    }

    .sidebar-item:nth-child(3):hover::before {
      background: #ffd700;
    }

    .sidebar-item:nth-child(4):hover {
      border-color: rgba(0, 255, 127, 0.5);
      box-shadow: 
        0 0 15px rgba(0, 255, 127, 0.3),
        inset 0 0 15px rgba(0, 255, 127, 0.05);
    }

    .sidebar-item:nth-child(4):hover::before {
      background: #00ff7f;
    }

    .sidebar-icon {
      font-size: 24px;
      min-width: 24px;
      text-align: center;
      filter: drop-shadow(0 0 5px currentColor);
    }

    .sidebar-text {
      font-size: 16px;
      font-weight: 500;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .sidebar-text {
      opacity: 0;
      width: 0;
      overflow: hidden;
    }

    .sidebar.collapsed .sidebar-content {
      padding: 20px 10px;
    }

    .sidebar.collapsed .sidebar-item {
      justify-content: center;
      padding: 15px 10px;
      gap: 0;
    }

    .sidebar.collapsed .sidebar-icon {
      margin: 0 auto;
    }

    /* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸï¼Œä¸ºä¾§è¾¹æ ç•™å‡ºç©ºé—´ */
    .city-stage {
      position: relative;
      margin-left: 200px;
      width: calc(100% - 200px);
      height: 80vh;
      min-height: 600px;
      background: linear-gradient(
        135deg,
        #0a0a0a 0%,
        #1a1a2e 25%,
        #16213e 50%,
        #0f3460 75%,
        #0a0a0a 100%
      );
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
      border-radius: 12px;
      box-shadow: 
        0 0 50px rgba(0, 255, 255, 0.3),
        inset 0 0 100px rgba(157, 78, 221, 0.1);
      transition: width 0.3s ease, margin-left 0.3s ease;
    }

    .sidebar.collapsed ~ .city-stage {
      margin-left: 60px;
      width: calc(100% - 60px);
    }

    /* å¦‚æœæœ‰èƒŒæ™¯å›¾ç‰‡ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œ */
    /* background-image: url('{% static "web/images/city_bg.jpg" %}'); */

    .citizen {
      position: absolute;
      cursor: pointer;
      transition: transform 0.3s ease, filter 0.3s ease;
      z-index: 10;
    }

    .citizen:hover {
      transform: translateY(-5px) scale(1.1);
      z-index: 100;
    }

    .citizen-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid transparent;
      box-shadow: 
        0 0 10px rgba(0, 255, 255, 0.6),
        0 0 20px rgba(157, 78, 221, 0.4),
        0 0 30px rgba(255, 0, 110, 0.3),
        inset 0 0 10px rgba(0, 255, 255, 0.2);
      animation: neonPulse 2s ease-in-out infinite alternate;
    }

    .citizen-avatar-placeholder {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, #9d4edd, #ff006e);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 20px;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    }

    @keyframes neonPulse {
      0% {
        box-shadow: 
          0 0 10px rgba(0, 255, 255, 0.6),
          0 0 20px rgba(157, 78, 221, 0.4),
          0 0 30px rgba(255, 0, 110, 0.3),
          inset 0 0 10px rgba(0, 255, 255, 0.2);
      }
      100% {
        box-shadow: 
          0 0 20px rgba(0, 255, 255, 0.9),
          0 0 30px rgba(157, 78, 221, 0.6),
          0 0 40px rgba(255, 0, 110, 0.5),
          inset 0 0 15px rgba(0, 255, 255, 0.3);
      }
    }

    .citizen-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      border: 1px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
      z-index: 1000;
    }

    .citizen-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.85);
    }

    .citizen:hover .citizen-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-15px);
    }

    /* ä¸ºä¸åŒç”¨æˆ·æ·»åŠ ä¸åŒçš„éœ“è™¹è‰²å½© */
    .citizen:nth-child(3n+1) .citizen-avatar {
      box-shadow: 
        0 0 10px rgba(0, 255, 255, 0.6),
        0 0 20px rgba(0, 255, 255, 0.4),
        0 0 30px rgba(0, 255, 255, 0.3),
        inset 0 0 10px rgba(0, 255, 255, 0.2);
    }

    .citizen:nth-child(3n+2) .citizen-avatar {
      box-shadow: 
        0 0 10px rgba(157, 78, 221, 0.6),
        0 0 20px rgba(157, 78, 221, 0.4),
        0 0 30px rgba(157, 78, 221, 0.3),
        inset 0 0 10px rgba(157, 78, 221, 0.2);
    }

    .citizen:nth-child(3n) .citizen-avatar {
      box-shadow: 
        0 0 10px rgba(255, 0, 110, 0.6),
        0 0 20px rgba(255, 0, 110, 0.4),
        0 0 30px rgba(255, 0, 110, 0.3),
        inset 0 0 10px rgba(255, 0, 110, 0.2);
    }

    /* éœ“è™¹æ‹›ç‰Œæ ·å¼ */
    .neon-sign {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 15px 25px;
      text-decoration: none;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid;
      border-radius: 8px;
      transition: all 0.3s ease;
      z-index: 20;
      backdrop-filter: blur(5px);
      min-width: 180px;
      box-shadow: 
        0 0 10px currentColor,
        inset 0 0 10px rgba(255, 255, 255, 0.1);
    }

    .neon-sign-cyan {
      color: #00ffff;
      border-color: #00ffff;
      text-shadow: 
        0 0 5px #00ffff,
        0 0 10px #00ffff,
        0 0 15px #00ffff,
        0 0 20px #00ffff;
      box-shadow: 
        0 0 10px rgba(0, 255, 255, 0.5),
        0 0 20px rgba(0, 255, 255, 0.3),
        inset 0 0 10px rgba(0, 255, 255, 0.1);
    }

    .neon-sign-purple {
      color: #9d4edd;
      border-color: #9d4edd;
      text-shadow: 
        0 0 5px #9d4edd,
        0 0 10px #9d4edd,
        0 0 15px #9d4edd,
        0 0 20px #9d4edd;
      box-shadow: 
        0 0 10px rgba(157, 78, 221, 0.5),
        0 0 20px rgba(157, 78, 221, 0.3),
        inset 0 0 10px rgba(157, 78, 221, 0.1);
    }

    .neon-sign-yellow {
      color: #ffd700;
      border-color: #ffd700;
      text-shadow: 
        0 0 5px #ffd700,
        0 0 10px #ffd700,
        0 0 15px #ffd700,
        0 0 20px #ffd700;
      box-shadow: 
        0 0 10px rgba(255, 215, 0, 0.5),
        0 0 20px rgba(255, 215, 0, 0.3),
        inset 0 0 10px rgba(255, 215, 0, 0.1);
    }

    .neon-sign:hover {
      transform: translateY(-3px) scale(1.05);
      animation: neonShake 0.5s ease-in-out;
      filter: brightness(1.3);
    }

    .neon-sign-cyan:hover {
      box-shadow: 
        0 0 20px rgba(0, 255, 255, 0.8),
        0 0 30px rgba(0, 255, 255, 0.6),
        0 0 40px rgba(0, 255, 255, 0.4),
        inset 0 0 15px rgba(0, 255, 255, 0.2);
    }

    .neon-sign-purple:hover {
      box-shadow: 
        0 0 20px rgba(157, 78, 221, 0.8),
        0 0 30px rgba(157, 78, 221, 0.6),
        0 0 40px rgba(157, 78, 221, 0.4),
        inset 0 0 15px rgba(157, 78, 221, 0.2);
    }

    .neon-sign-yellow:hover {
      box-shadow: 
        0 0 20px rgba(255, 215, 0, 0.8),
        0 0 30px rgba(255, 215, 0, 0.6),
        0 0 40px rgba(255, 215, 0, 0.4),
        inset 0 0 15px rgba(255, 215, 0, 0.2);
    }

    @keyframes neonShake {
      0%, 100% { transform: translateY(-3px) scale(1.05) translateX(0); }
      25% { transform: translateY(-3px) scale(1.05) translateX(-2px); }
      75% { transform: translateY(-3px) scale(1.05) translateX(2px); }
    }

    .sign-icon {
      font-size: 32px;
      margin-bottom: 8px;
      filter: drop-shadow(0 0 5px currentColor);
    }

    .sign-text {
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 2px;
      margin-bottom: 4px;
      font-family: 'Courier New', monospace;
    }

    .sign-subtitle {
      font-size: 12px;
      opacity: 0.9;
      letter-spacing: 1px;
      font-family: 'Courier New', monospace;
    }


    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal-content {
      box-shadow: 
        0 0 30px rgba(0, 255, 255, 0.3),
        inset 0 0 30px rgba(157, 78, 221, 0.1);
    }

    .modal-content input:focus {
      background: #16213e !important;
      border-color: #00ffff !important;
      color: #e0e0e0 !important;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      outline: none;
    }

    .modal-content .btn-primary:hover {
      box-shadow: 0 0 20px rgba(157, 78, 221, 0.8);
      transform: translateY(-2px);
    }

    .btn-close-white {
      filter: invert(1) grayscale(100%) brightness(200%);
    }

    /* åœ°å—æ ·å¼ */
    .land-plot {
      position: absolute;
      cursor: pointer;
      transition: transform 0.3s ease, filter 0.3s ease;
      transform-style: preserve-3d;
    }

    .land-plot:hover {
      transform: translateY(-10px) scale(1.15);
      filter: brightness(1.3);
    }

    /* åœ°å—å›¾ç‰‡æ ·å¼ */
    .land-plot-image {
      width: 70px;
      height: auto;
      display: block;
      filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.6)) 
              drop-shadow(0 0 20px rgba(0, 255, 255, 0.4))
              drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
      transition: all 0.3s ease;
    }

    /* ç©ºåœ°å—å›¾ç‰‡æ ·å¼ - é€æ˜åº¦å’Œæµ®åŠ¨åŠ¨ç”» */
    .land-plot-empty {
      opacity: 0.8;
      animation: plotFloat 3s ease-in-out infinite;
    }

    @keyframes plotFloat {
      0%, 100% {
        transform: translateY(0px);
      }
      50% {
        transform: translateY(-8px);
      }
    }

    /* å·²å”®åœ°å—å›¾ç‰‡æ ·å¼ - å‘å…‰æ•ˆæœ */
    .land-plot-owned .land-plot-image {
      filter: drop-shadow(0 0 15px rgba(157, 78, 221, 0.8)) 
              drop-shadow(0 0 25px rgba(157, 78, 221, 0.6))
              drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
    }

    .land-plot:hover .land-plot-image {
      filter: drop-shadow(0 0 20px rgba(0, 255, 255, 0.9)) 
              drop-shadow(0 0 30px rgba(0, 255, 255, 0.7))
              drop-shadow(0 8px 20px rgba(0, 0, 0, 0.6));
    }

    .land-plot-owned:hover .land-plot-image {
      filter: drop-shadow(0 0 25px rgba(157, 78, 221, 1)) 
              drop-shadow(0 0 35px rgba(157, 78, 221, 0.8))
              drop-shadow(0 8px 20px rgba(0, 0, 0, 0.6));
    }

    /* åœ°å—æç¤ºæ¡† */
    .land-plot-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-10px);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      border: 1px solid rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
      z-index: 1000;
    }

    .land-plot-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.85);
    }

    .land-plot:hover .land-plot-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-15px);
    }
  </style>

  <!-- åœ°å—è¯¦æƒ…å’Œè´­ä¹°æ¨¡æ€æ¡† -->
  <div class="modal fade" id="landPlotModal" tabindex="-1" aria-labelledby="landPlotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: #1a1a2e; border: 1px solid rgba(0, 255, 255, 0.3);">
        <div class="modal-header" style="border-bottom: 1px solid rgba(0, 255, 255, 0.3);">
          <h5 class="modal-title" id="landPlotModalLabel" style="color: #00ffff;">åœ°å—è¯¦æƒ…</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center" style="color: #e0e0e0;">
          <form action="{% url 'web:buy_land' %}" method="POST" id="buy-land-form">
            {% csrf_token %}
            <input type="hidden" name="plot_id" id="buy-plot-id" value="">
            
            <p id="plot-price-info" style="color: #00ff00; font-size: 18px; margin-bottom: 1.5rem; display: none;">
              <span style="font-size: 24px;">ğŸ’°</span> ä»·æ ¼ï¼š<strong id="price-display"></strong> é‡‘å¸
            </p>
            
            <p id="plot-owner-info" style="color: #9d4edd; font-size: 16px; margin-bottom: 1.5rem; display: none;">
              æ‰€æœ‰è€…ï¼š<strong id="owner-display"></strong>
            </p>
            
            <div id="buy-btn-container" style="display: none;">
              <button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #00ff00, #00cc00); border: none; color: #000;">
                ğŸ’° è´­ä¹°åœ°çš®
              </button>
            </div>
            
            <div id="my-plot-btn-container" style="display: none; margin-top: 1rem;">
              <button type="button" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #00ffff, #0099cc); border: none; color: #000;" onclick="alert('è£…ä¿®åŠŸèƒ½å¼€å‘ä¸­...');">
                ğŸ  è¿›å…¥/è£…ä¿®
              </button>
            </div>
            
            <div id="login-prompt-buy" style="display: none; color: #b0b0b0; padding: 1rem;">
              è¯·å…ˆ<a href="{% url 'web:login' %}" style="color: #00ffff;">ç™»å½•</a>ä»¥è´­ä¹°åœ°å—
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·èµ„æ–™å’Œæ‰“èµæ¨¡æ€æ¡† -->
  <div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background: #1a1a2e; border: 1px solid rgba(0, 255, 255, 0.3);">
        <div class="modal-header" style="border-bottom: 1px solid rgba(0, 255, 255, 0.3);">
          <h5 class="modal-title" id="userProfileModalLabel" style="color: #00ffff;">ç”¨æˆ·èµ„æ–™</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center" style="color: #e0e0e0;">
          <div id="modalAvatar" class="mb-3">
            <!-- å¤´åƒå°†åŠ¨æ€å¡«å…… -->
          </div>
          <h4 id="modalNickname" style="color: #00ffff; margin-bottom: 0.5rem;"></h4>
          <p id="modalLevel" style="color: #b0b0b0; margin-bottom: 1.5rem;"></p>
          
          <div id="transferFormContainer" style="display: none;">
            <form method="POST" action="{% url 'web:transfer_coins' %}">
              {% csrf_token %}
              <input type="hidden" name="recipient_id" id="modalRecipientId">
              <div class="mb-3">
                <label for="transferAmount" class="form-label" style="color: #e0e0e0;">æ‰“èµé‡‘é¢</label>
                <input 
                  type="number" 
                  class="form-control" 
                  id="transferAmount" 
                  name="amount" 
                  min="1" 
                  required
                  style="background: #16213e; border: 1px solid rgba(0, 255, 255, 0.3); color: #e0e0e0;"
                >
              </div>
              <button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #9d4edd, #ff006e); border: none;">
                ğŸ’° æ‰“èµé‡‘å¸
              </button>
            </form>
          </div>
          <div id="selfTransferMessage" style="display: none; color: #ffd700; padding: 1rem;">
            âš ï¸ ä¸èƒ½ç»™è‡ªå·±è½¬è´¦
          </div>
          <div id="loginPrompt" style="display: none; color: #b0b0b0; padding: 1rem;">
            è¯·å…ˆç™»å½•ä»¥æ‰“èµ
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¼ é€’ç”¨æˆ·è®¤è¯çŠ¶æ€ -->
  <script id="auth-data" type="application/json">{% if user.is_authenticated %}"true"{% else %}"false"{% endif %}</script>
  <script>
    // å°† Django æ¨¡æ¿å˜é‡è½¬æ¢ä¸º JavaScript å˜é‡
    var isUserAuthenticated = JSON.parse(document.getElementById('auth-data').textContent) === "true";
    
    // ä¾§è¾¹æ å±•å¼€/æ”¶ç¼©åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      
      // ä»æœ¬åœ°å­˜å‚¨è¯»å–ä¾§è¾¹æ çŠ¶æ€
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        sidebar.classList.add('collapsed');
      }
      
      // åˆ‡æ¢ä¾§è¾¹æ çŠ¶æ€
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', function() {
          sidebar.classList.toggle('collapsed');
          // ä¿å­˜çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
          localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });
      }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      const citizens = document.querySelectorAll('.citizen');
      
      citizens.forEach(function(citizen) {
        // ç”Ÿæˆéšæœºä½ç½®
        const topPercent = 10 + Math.random() * 70; // 10% - 80%
        const leftPercent = 5 + Math.random() * 90; // 5% - 95%
        
        citizen.style.top = topPercent + '%';
        citizen.style.left = leftPercent + '%';
        
        // æ·»åŠ éšæœºå»¶è¿ŸåŠ¨ç”»ï¼Œè®©å®ƒä»¬æ›´æœ‰ç”Ÿå‘½åŠ›
        const delay = Math.random() * 2;
        citizen.style.animationDelay = delay + 's';
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        citizen.addEventListener('click', function() {
          const userId = this.getAttribute('data-user-id');
          const username = this.getAttribute('data-username');
          const nickname = this.getAttribute('data-nickname');
          const avatarUrl = this.getAttribute('data-avatar-url');
          const level = this.getAttribute('data-level');
          const isCurrentUserAttr = this.getAttribute('data-is-current-user');
          const isCurrentUser = isCurrentUserAttr === 'true';
          
          // è·å–æ¨¡æ€æ¡†å…ƒç´ 
          const modalElement = document.getElementById('userProfileModal');
          if (!modalElement) {
            console.error('æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
            return;
          }
          
          // å¡«å……æ¨¡æ€æ¡†å†…å®¹
          const modalAvatar = document.getElementById('modalAvatar');
          const modalNickname = document.getElementById('modalNickname');
          const modalLevel = document.getElementById('modalLevel');
          const modalRecipientId = document.getElementById('modalRecipientId');
          const transferFormContainer = document.getElementById('transferFormContainer');
          const selfTransferMessage = document.getElementById('selfTransferMessage');
          const loginPrompt = document.getElementById('loginPrompt');
          
          // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å…ƒç´ éƒ½å­˜åœ¨
          if (!modalAvatar || !modalNickname || !modalLevel) {
            console.error('æ¨¡æ€æ¡†å†…å®¹å…ƒç´ ä¸å­˜åœ¨');
            return;
          }
          
          // è®¾ç½®å¤´åƒ - ä½¿ç”¨å®‰å…¨çš„ DOM æ“ä½œ
          modalAvatar.innerHTML = ''; // æ¸…ç©ºå†…å®¹
          if (avatarUrl && avatarUrl.trim() !== '' && avatarUrl !== "''") {
            const img = document.createElement('img');
            img.src = avatarUrl;
            img.alt = nickname || username || 'ç”¨æˆ·å¤´åƒ';
            img.className = 'rounded-circle';
            img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border: 3px solid #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);';
            img.onerror = function() {
              // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
              const initial = (username && username.length > 0) ? username.charAt(0).toUpperCase() : '?';
              const placeholder = document.createElement('div');
              placeholder.className = 'rounded-circle d-inline-flex align-items-center justify-content-center';
              placeholder.style.cssText = 'width: 100px; height: 100px; background: linear-gradient(135deg, #9d4edd, #ff006e); color: #fff; font-size: 36px; font-weight: bold; border: 3px solid #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);';
              placeholder.textContent = initial;
              modalAvatar.innerHTML = '';
              modalAvatar.appendChild(placeholder);
            };
            modalAvatar.appendChild(img);
          } else {
            const initial = (username && username.length > 0) ? username.charAt(0).toUpperCase() : '?';
            const placeholder = document.createElement('div');
            placeholder.className = 'rounded-circle d-inline-flex align-items-center justify-content-center';
            placeholder.style.cssText = 'width: 100px; height: 100px; background: linear-gradient(135deg, #9d4edd, #ff006e); color: #fff; font-size: 36px; font-weight: bold; border: 3px solid #00ffff; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);';
            placeholder.textContent = initial;
            modalAvatar.appendChild(placeholder);
          }
          
          // è®¾ç½®æ˜µç§°å’Œç­‰çº§
          modalNickname.textContent = nickname || username || 'æœªçŸ¥ç”¨æˆ·';
          modalLevel.textContent = 'Lv.' + (level || '1');
          
          // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å’Œæ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
          if (!isUserAuthenticated) {
            // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æç¤ºï¼Œéšè—å…¶ä»–
            if (transferFormContainer) transferFormContainer.style.display = 'none';
            if (selfTransferMessage) selfTransferMessage.style.display = 'none';
            if (loginPrompt) loginPrompt.style.display = 'block';
          } else if (isCurrentUser) {
            // å·²ç™»å½•ä½†ç‚¹å‡»è‡ªå·±ï¼šæ˜¾ç¤ºä¸èƒ½ç»™è‡ªå·±è½¬è´¦æç¤º
            if (transferFormContainer) transferFormContainer.style.display = 'none';
            if (loginPrompt) loginPrompt.style.display = 'none';
            if (selfTransferMessage) selfTransferMessage.style.display = 'block';
          } else {
            // å·²ç™»å½•ä¸”ç‚¹å‡»ä»–äººï¼šæ˜¾ç¤ºæ‰“èµè¡¨å•
            if (selfTransferMessage) selfTransferMessage.style.display = 'none';
            if (loginPrompt) loginPrompt.style.display = 'none';
            if (transferFormContainer) {
              transferFormContainer.style.display = 'block';
              // è®¾ç½®æ¥æ”¶è€…ID
              if (modalRecipientId) {
                modalRecipientId.value = userId || '';
              }
              // é‡ç½®é‡‘é¢è¾“å…¥
              const transferAmount = document.getElementById('transferAmount');
              if (transferAmount) {
                transferAmount.value = '';
              }
            }
          }
          
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          try {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
          } catch (error) {
            console.error('æ˜¾ç¤ºæ¨¡æ€æ¡†å¤±è´¥:', error);
          }
        });
      });
    });

    // åœ°å—ç‚¹å‡»äº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
      const landPlots = document.querySelectorAll('.land-plot');
      const currentUserId = {% if current_user_id %}{{ current_user_id }}{% else %}null{% endif %};
      
      landPlots.forEach(function(plot) {
        plot.addEventListener('click', function() {
          // è·å–åœ°å—å®Œæ•´æ•°æ®å±æ€§
          const plotId = this.getAttribute('data-id');
          const plotPrice = this.getAttribute('data-price');
          const plotName = this.getAttribute('data-name');
          const plotOwnerId = this.getAttribute('data-owner-id');
          const plotOwnerName = this.getAttribute('data-owner-name');
          const plotIsMine = this.getAttribute('data-is-mine');
          
          // è·å–æ¨¡æ€æ¡†å…ƒç´ 
          const modalElement = document.getElementById('landPlotModal');
          if (!modalElement) {
            console.error('åœ°å—æ¨¡æ€æ¡†å…ƒç´ ä¸å­˜åœ¨');
            return;
          }
          
          // è·å–æ¨¡æ€æ¡†å†…çš„å…ƒç´ 
          const modalTitle = document.getElementById('landPlotModalLabel');
          const plotPriceInfo = document.getElementById('plot-price-info');
          const priceDisplay = document.getElementById('price-display');
          const plotOwnerInfo = document.getElementById('plot-owner-info');
          const ownerDisplay = document.getElementById('owner-display');
          const buyBtnContainer = document.getElementById('buy-btn-container');
          const myPlotBtnContainer = document.getElementById('my-plot-btn-container');
          const loginPromptBuy = document.getElementById('login-prompt-buy');
          const buyPlotIdInput = document.getElementById('buy-plot-id');
          
          // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜ä¸ºåœ°å—åå­—
          if (modalTitle) {
            modalTitle.textContent = plotName || 'åœ°å—è¯¦æƒ…';
          }
          
          // è®¾ç½®åœ°å—IDåˆ°éšè—è¾“å…¥æ¡†
          if (buyPlotIdInput) {
            buyPlotIdInput.value = plotId || '';
          }
          
          // åˆ¤æ–­ä¸‰ç§çŠ¶æ€
          const hasOwner = plotOwnerId && plotOwnerId.trim() !== '';
          const isMine = plotIsMine === 'yes';
          
          if (!hasOwner) {
            // Case A: ç©ºåœ° (No Owner) -> æ˜¾ç¤ºä»·æ ¼ï¼Œæ˜¾ç¤ºè´­ä¹°æŒ‰é’®ï¼Œéšè—å…¶ä»–æŒ‰é’®
            if (plotPriceInfo) {
              plotPriceInfo.style.display = 'block';
            }
            if (priceDisplay) {
              priceDisplay.textContent = plotPrice || '0';
            }
            if (plotOwnerInfo) {
              plotOwnerInfo.style.display = 'none';
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!isUserAuthenticated) {
              // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•æç¤ºï¼Œéšè—è´­ä¹°æŒ‰é’®
              if (buyBtnContainer) {
                buyBtnContainer.style.display = 'none';
              }
              if (myPlotBtnContainer) {
                myPlotBtnContainer.style.display = 'none';
              }
              if (loginPromptBuy) {
                loginPromptBuy.style.display = 'block';
              }
            } else {
              // å·²ç™»å½•ï¼šæ˜¾ç¤ºè´­ä¹°æŒ‰é’®ï¼Œéšè—ç™»å½•æç¤º
              if (loginPromptBuy) {
                loginPromptBuy.style.display = 'none';
              }
              if (myPlotBtnContainer) {
                myPlotBtnContainer.style.display = 'none';
              }
              if (buyBtnContainer) {
                buyBtnContainer.style.display = 'block';
              }
            }
          } else if (isMine) {
            // Case C: æˆ‘çš„åœ° (Owner == Me) -> æ˜¾ç¤º"è¿™æ˜¯æˆ‘çš„å®¶"ï¼Œéšè—è´­ä¹°æŒ‰é’®ï¼Œæ˜¾ç¤º"è¿›å…¥/è£…ä¿®"æŒ‰é’®
            if (plotPriceInfo) {
              plotPriceInfo.style.display = 'none';
            }
            if (plotOwnerInfo) {
              plotOwnerInfo.style.display = 'block';
              plotOwnerInfo.innerHTML = '<span style="color: #00ffff; font-size: 18px;">ğŸ  è¿™æ˜¯æˆ‘çš„å®¶</span>';
            }
            if (buyBtnContainer) {
              buyBtnContainer.style.display = 'none';
            }
            if (myPlotBtnContainer) {
              myPlotBtnContainer.style.display = 'block';
            }
            if (loginPromptBuy) {
              loginPromptBuy.style.display = 'none';
            }
          } else {
            // Case B: åˆ«äººçš„åœ° (Owner != Me) -> æ˜¾ç¤º"è¿™æ˜¯ [åå­—] çš„åœ°ç›˜"ï¼Œéšè—è´­ä¹°æŒ‰é’®
            if (plotPriceInfo) {
              plotPriceInfo.style.display = 'none';
            }
            if (plotOwnerInfo) {
              plotOwnerInfo.style.display = 'block';
              plotOwnerInfo.innerHTML = '<span style="color: #9d4edd; font-size: 16px;">è¿™æ˜¯ <strong>' + (plotOwnerName || 'æœªçŸ¥ç”¨æˆ·') + '</strong> çš„åœ°ç›˜</span>';
            }
            if (ownerDisplay) {
              ownerDisplay.textContent = plotOwnerName || 'æœªçŸ¥ç”¨æˆ·';
            }
            if (buyBtnContainer) {
              buyBtnContainer.style.display = 'none';
            }
            if (myPlotBtnContainer) {
              myPlotBtnContainer.style.display = 'none';
            }
            if (loginPromptBuy) {
              loginPromptBuy.style.display = 'none';
            }
          }
          
          // æ˜¾ç¤ºæ¨¡æ€æ¡†
          try {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
          } catch (error) {
            console.error('æ˜¾ç¤ºåœ°å—æ¨¡æ€æ¡†å¤±è´¥:', error);
          }
        });
      });
      
      // æ·»åŠ è¡¨å•æäº¤éªŒè¯
      const buyLandForm = document.getElementById('buy-land-form');
      if (buyLandForm) {
        buyLandForm.addEventListener('submit', function(e) {
          const plotIdInput = document.getElementById('buy-plot-id');
          if (!plotIdInput || !plotIdInput.value || plotIdInput.value.trim() === '') {
            e.preventDefault();
            alert('é”™è¯¯ï¼šåœ°å—IDæ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return false;
          }
          
          if (!isUserAuthenticated) {
            e.preventDefault();
            alert('è¯·å…ˆç™»å½•');
            return false;
          }
          
          // ç¡®è®¤è´­ä¹°
          const price = document.getElementById('price-display')?.textContent || '0';
          if (!confirm(`ç¡®è®¤èŠ±è´¹ ${price} é‡‘å¸è´­ä¹°æ­¤åœ°å—å—ï¼Ÿ`)) {
            e.preventDefault();
            return false;
          }
        });
      }
    });
  </script>
{% endblock %}
