{% extends 'web/base.html' %}
{% load static %}
{% block title %}AIåŠ©æ‰‹{% endblock %}

{% block content %}
<style>
  .chat-container {
    max-width: 900px;
    margin: 0 auto;
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    background: rgba(22, 33, 62, 0.8);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 12px;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
    overflow: hidden;
  }

  .chat-header {
    padding: 20px;
    border-bottom: 1px solid rgba(0, 255, 255, 0.3);
    background: rgba(22, 33, 62, 0.9);
  }

  .chat-header h2 {
    margin: 0;
    color: #00ffff;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    font-size: 24px;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: rgba(10, 15, 30, 0.5);
  }

  .chat-messages::-webkit-scrollbar {
    width: 8px;
  }

  .chat-messages::-webkit-scrollbar-track {
    background: rgba(22, 33, 62, 0.5);
  }

  .chat-messages::-webkit-scrollbar-thumb {
    background: rgba(0, 255, 255, 0.3);
    border-radius: 4px;
  }

  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 255, 255, 0.5);
  }

  .message {
    margin-bottom: 20px;
    display: flex;
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.ai {
    justify-content: flex-start;
  }

  .message-content {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 12px;
    word-wrap: break-word;
    line-height: 1.5;
  }

  .message.user .message-content {
    background: linear-gradient(135deg, #9d4edd, #ff006e);
    color: #fff;
    border-bottom-right-radius: 4px;
    box-shadow: 0 0 15px rgba(157, 78, 221, 0.4);
  }

  .message.ai .message-content {
    background: rgba(0, 255, 255, 0.1);
    color: #e0e0e0;
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-bottom-left-radius: 4px;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
  }

  .message-label {
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 5px;
    font-weight: bold;
  }

  .message.user .message-label {
    text-align: right;
    color: #9d4edd;
  }

  .message.ai .message-label {
    text-align: left;
    color: #00ffff;
  }

  .chat-input-container {
    padding: 20px;
    border-top: 1px solid rgba(0, 255, 255, 0.3);
    background: rgba(22, 33, 62, 0.9);
  }

  .chat-input-form {
    display: flex;
    gap: 10px;
  }

  .chat-input {
    flex: 1;
    padding: 12px 18px;
    background: rgba(10, 15, 30, 0.8);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 8px;
    color: #e0e0e0;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .chat-input:focus {
    outline: none;
    border-color: #00ffff;
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    background: rgba(10, 15, 30, 0.95);
  }

  .chat-input::placeholder {
    color: rgba(224, 224, 224, 0.5);
  }

  .send-button {
    padding: 12px 30px;
    background: linear-gradient(135deg, #9d4edd, #ff006e);
    border: none;
    border-radius: 8px;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 0 15px rgba(157, 78, 221, 0.4);
  }

  .send-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 0 25px rgba(157, 78, 221, 0.6);
  }

  .send-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .loading-indicator {
    display: none;
    padding: 12px 18px;
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 12px;
    color: #00ffff;
    font-size: 14px;
    margin-bottom: 20px;
  }

  .loading-indicator.active {
    display: block;
  }

  .loading-dots {
    display: inline-block;
  }

  .loading-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #00ffff;
    margin: 0 2px;
    animation: bounce 1.4s infinite ease-in-out both;
  }

  .loading-dots span:nth-child(1) {
    animation-delay: -0.32s;
  }

  .loading-dots span:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes bounce {
    0%, 80%, 100% {
      transform: scale(0);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>

<div class="container mt-4">
  <h1 class="mb-4" style="color: #00ffff; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
    ğŸ¤– CyberBot AIåŠ©æ‰‹
  </h1>
  
  <div class="chat-container">
    <div class="chat-header">
      <h2>ğŸ’¬ ä¸ CyberBot å¯¹è¯</h2>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="message ai">
        <div>
          <div class="message-label">ğŸ¤– CyberBot</div>
          <div class="message-content">
            ä½ å¥½ï¼æˆ‘æ˜¯ CyberBotï¼Œä½ çš„èµ›åšæœ‹å…‹ä¸–ç•Œ AI åŠ©æ‰‹ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
          </div>
        </div>
      </div>
    </div>
    
    <div class="loading-indicator" id="loadingIndicator">
      <span>CyberBot æ­£åœ¨æ€è€ƒ</span>
      <span class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </span>
    </div>
    
    <div class="chat-input-container">
      <div class="chat-input-form" id="chatForm">
        <input
          type="text"
          class="chat-input"
          id="messageInput"
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          autocomplete="off"
        >
        <button type="button" class="send-button" id="sendButton">
          å‘é€
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const chatMessages = document.getElementById('chatMessages');
  const chatForm = document.getElementById('chatForm');
  const messageInput = document.getElementById('messageInput');
  const sendButton = document.getElementById('sendButton');
  const loadingIndicator = document.getElementById('loadingIndicator');

  // è·å– CSRF Token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // è·å– CSRF Tokenï¼ˆä¼˜å…ˆä» cookieï¼Œå¦‚æœæ²¡æœ‰åˆ™ä» meta æ ‡ç­¾ï¼‰
  function getCSRFToken() {
    // å…ˆå°è¯•ä» cookie è·å–
    let token = getCookie('csrftoken');
    if (token) {
      return token;
    }
    // å¦‚æœæ²¡æœ‰ï¼Œå°è¯•ä» meta æ ‡ç­¾è·å–
    const metaTag = document.querySelector('meta[name=csrf-token]');
    if (metaTag) {
      return metaTag.getAttribute('content');
    }
    return null;
  }

  // æ»šåŠ¨åˆ°åº•éƒ¨
  function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
  function addMessage(text, isUser) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
    
    const label = isUser ? 'ğŸ‘¤ ä½ ' : 'ğŸ¤– CyberBot';
    
    // è½¬ä¹‰ HTML é˜²æ­¢ XSS
    const escapedText = text.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;')
                           .replace(/"/g, '&quot;')
                           .replace(/'/g, '&#039;')
                           .replace(/\n/g, '<br>');
    
    messageDiv.innerHTML = `
      <div>
        <div class="message-label">${label}</div>
        <div class="message-content">${escapedText}</div>
      </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
  }

  // å‘é€æ¶ˆæ¯
  async function sendMessage() {
    console.log('æ­£åœ¨å‘é€æ¶ˆæ¯...');
    
    const message = messageInput.value.trim();
    if (!message) {
      console.log('æ¶ˆæ¯ä¸ºç©ºï¼Œå–æ¶ˆå‘é€');
      return;
    }

    console.log('æ¶ˆæ¯å†…å®¹:', message);

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessage(message, true);
    const messageToSend = message; // ä¿å­˜è¦å‘é€çš„æ¶ˆæ¯
    messageInput.value = '';
    
    // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
    messageInput.disabled = true;
    sendButton.disabled = true;
    loadingIndicator.classList.add('active');
    scrollToBottom();

    try {
      // è·å– CSRF Token
      const csrfToken = getCSRFToken();
      console.log('CSRF Token:', csrfToken ? 'å·²è·å–' : 'æœªæ‰¾åˆ°');
      
      // å‡†å¤‡è¯·æ±‚å¤´
      const headers = {
        'Content-Type': 'application/json'
      };
      
      // å¦‚æœæœ‰ CSRF Tokenï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
      if (csrfToken) {
        headers['X-CSRFToken'] = csrfToken;
      }

      // å‡†å¤‡è¯·æ±‚ä½“
      const requestBody = JSON.stringify({
        message: messageToSend
      });

      // è·å– URL
      const chatUrl = '{% url "web:ai_chat" %}';
      console.log('å‘é€ POST è¯·æ±‚åˆ°:', chatUrl);
      console.log('è¯·æ±‚æ–¹æ³•: POST');
      console.log('è¯·æ±‚ä½“:', requestBody);
      console.log('è¯·æ±‚å¤´:', headers);

      // å‘é€ POST è¯·æ±‚
      const response = await fetch(chatUrl, {
        method: 'POST',
        headers: headers,
        body: requestBody,
        credentials: 'same-origin' // ç¡®ä¿å‘é€ cookie
      });

      console.log('å“åº”çŠ¶æ€:', response.status);
      console.log('å“åº”çŠ¶æ€æ–‡æœ¬:', response.statusText);

      const data = await response.json();
      console.log('å“åº”æ•°æ®:', data);
      
      if (response.ok) {
        // æ·»åŠ  AI å›å¤
        addMessage(data.response, false);
        console.log('æ¶ˆæ¯å‘é€æˆåŠŸï¼Œå·²æ”¶åˆ° AI å›å¤');
      } else {
        addMessage('âŒ é”™è¯¯ï¼š' + (data.error || 'è¯·æ±‚å¤±è´¥'), false);
        console.error('è¯·æ±‚å¤±è´¥:', data);
      }
    } catch (error) {
      console.error('è¯·æ±‚é”™è¯¯:', error);
      addMessage('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥...', false);
    } finally {
      // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
      messageInput.disabled = false;
      sendButton.disabled = false;
      loadingIndicator.classList.remove('active');
      messageInput.focus();
    }
  }

  // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ç›´æ¥ç»‘å®šï¼Œä¸é€šè¿‡è¡¨å•æäº¤
  sendButton.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    console.log('å‘é€æŒ‰é’®è¢«ç‚¹å‡»');
    sendMessage();
    return false;
  });

  // Enter é”®å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      e.stopPropagation();
      console.log('Enter é”®è¢«æŒ‰ä¸‹ï¼Œå‘é€æ¶ˆæ¯');
      sendMessage();
      return false;
    }
  });

  // é¡µé¢åŠ è½½åèšç„¦è¾“å…¥æ¡†
  window.addEventListener('load', () => {
    messageInput.focus();
  });
</script>
{% endblock %}

