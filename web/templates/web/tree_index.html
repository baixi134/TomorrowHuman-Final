{% extends "web/base.html" %}
{% block title %}çŸ¥è¯†å®‡å®™{% endblock %}

{% block content %}
  <style>
    /* å…¨å±å®¹å™¨ - æ·»åŠ åŠ¨æ€èƒŒæ™¯ */
    #universe {
      width: 100vw;
      height: 90vh;
      position: relative;
      margin: 0;
      padding: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(157, 78, 221, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(255, 0, 110, 0.05) 0%, transparent 50%),
        linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
      background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%;
      animation: backgroundShift 20s ease infinite;
      overflow: hidden;
    }

    @keyframes backgroundShift {
      0%, 100% {
        background-position: 0% 0%, 100% 100%, 50% 50%, 0% 0%;
      }
      50% {
        background-position: 100% 100%, 0% 0%, 100% 0%, 0% 0%;
      }
    }

    /* æ·»åŠ è£…é¥°æ€§ç²’å­æ•ˆæœ */
    #universe::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(2px 2px at 20% 30%, rgba(0, 255, 255, 0.3), transparent),
        radial-gradient(2px 2px at 60% 70%, rgba(157, 78, 221, 0.3), transparent),
        radial-gradient(1px 1px at 50% 50%, rgba(255, 0, 110, 0.2), transparent),
        radial-gradient(1px 1px at 80% 10%, rgba(0, 255, 255, 0.2), transparent),
        radial-gradient(2px 2px at 90% 60%, rgba(157, 78, 221, 0.3), transparent);
      background-size: 200% 200%, 150% 150%, 180% 180%, 160% 160%, 170% 170%;
      background-position: 0% 0%, 100% 100%, 50% 50%, 0% 100%, 100% 0%;
      animation: particleMove 30s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes particleMove {
      0% {
        background-position: 0% 0%, 100% 100%, 50% 50%, 0% 100%, 100% 0%;
      }
      100% {
        background-position: 100% 100%, 0% 0%, 150% 150%, 100% 0%, 0% 100%;
      }
    }

    /* æ‚¬æµ®æŒ‰é’® - æ›´ç²¾è‡´çš„æ ·å¼ */
    .floating-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border: 3px solid var(--neon-cyan);
      color: white;
      font-size: 32px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 
        0 0 20px rgba(0, 255, 255, 0.6),
        0 0 40px rgba(157, 78, 221, 0.5),
        0 0 60px rgba(255, 0, 110, 0.3),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .floating-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .floating-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .floating-btn:hover {
      transform: scale(1.15) rotate(90deg);
      box-shadow: 
        0 0 30px rgba(0, 255, 255, 0.9),
        0 0 60px rgba(157, 78, 221, 0.7),
        0 0 90px rgba(255, 0, 110, 0.5),
        inset 0 0 30px rgba(255, 255, 255, 0.2);
      border-color: #00ffff;
    }

    .floating-btn:active {
      transform: scale(1.05) rotate(90deg);
    }

    /* æ¨¡æ€æ¡†æ ·å¼ - æ›´ç²¾è‡´ */
    .modal-content {
      background: linear-gradient(135deg, rgba(22, 33, 62, 0.98), rgba(26, 26, 46, 0.98));
      border: 2px solid var(--border-glow);
      border-radius: 16px;
      color: var(--text-primary);
      box-shadow: 
        0 0 30px rgba(0, 255, 255, 0.3),
        0 0 60px rgba(157, 78, 221, 0.2),
        inset 0 0 20px rgba(0, 255, 255, 0.05);
      backdrop-filter: blur(10px);
    }

    .modal-header {
      border-bottom: 2px solid var(--border-glow);
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(157, 78, 221, 0.1));
      border-radius: 14px 14px 0 0;
      padding: 1.5rem;
    }

    .modal-title {
      background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      font-size: 1.5rem;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-footer {
      border-top: 2px solid var(--border-glow);
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.05), rgba(157, 78, 221, 0.05));
      border-radius: 0 0 14px 14px;
      padding: 1.5rem;
    }

    .form-control,
    .form-control:focus {
      background: rgba(22, 33, 62, 0.9);
      border: 2px solid var(--border-glow);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: var(--neon-cyan);
      box-shadow: 
        0 0 15px rgba(0, 255, 255, 0.4),
        inset 0 0 10px rgba(0, 255, 255, 0.1);
      background: rgba(22, 33, 62, 1);
      outline: none;
    }

    .form-control::placeholder {
      color: rgba(176, 176, 176, 0.5);
    }

    .form-label {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-label::before {
      content: 'âœ¨';
      font-size: 0.9rem;
    }

    /* æŒ‰é’®ä¼˜åŒ– */
    .btn-primary {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border: 2px solid var(--neon-cyan);
      box-shadow: 0 0 15px rgba(157, 78, 221, 0.5);
      transition: all 0.3s ease;
      font-weight: 600;
      padding: 0.6rem 1.5rem;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(157, 78, 221, 0.7);
      border-color: #00ffff;
    }

    .btn-secondary {
      background: rgba(22, 33, 62, 0.8);
      border: 2px solid var(--border-glow);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: rgba(22, 33, 62, 1);
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }

    /* ç§»é™¤å®¹å™¨çš„paddingï¼Œè®©å›¾è¡¨å…¨å± */
    .container {
      padding: 0;
      max-width: 100%;
    }

    /* æ·»åŠ åŠ è½½åŠ¨ç”» */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>

  <!-- é¡µé¢æ ‡é¢˜ -->
  <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; text-align: center; pointer-events: none;">
    <h1 style="
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #00ffff, #9d4edd, #ff006e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      margin: 0;
      letter-spacing: 2px;
    ">ğŸŒŒ çŸ¥è¯†å®‡å®™</h1>
    <p style="
      color: rgba(176, 176, 176, 0.8);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    ">æ¢ç´¢æ— é™çš„çŸ¥è¯†æ ‘ï¼Œç‚¹å‡»èŠ‚ç‚¹å±•å¼€ï¼Œæ‹–æ‹½ç¼©æ”¾ç”»å¸ƒ</p>
  </div>

  <div id="universe"></div>

  {% if user.is_authenticated %}
    <button
      type="button"
      class="floating-btn"
      data-bs-toggle="modal"
      data-bs-target="#createNodeModal"
      title="å‘å¸ƒæ–°è¯é¢˜"
    >
      +
    </button>

    <!-- åˆ›å»ºèŠ‚ç‚¹æ¨¡æ€æ¡† -->
    <div class="modal fade" id="createNodeModal" tabindex="-1" aria-labelledby="createNodeModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createNodeModalLabel">ğŸŒŒ å‘å¸ƒæ–°è¯é¢˜</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="post" action="{% url 'web:create_node' %}">
            {% csrf_token %}
            <div class="modal-body">
              <div class="mb-3">
                <label for="id_title" class="form-label">æ ‡é¢˜</label>
                <input
                  type="text"
                  class="form-control"
                  id="id_title"
                  name="title"
                  required
                  maxlength="200"
                  placeholder="è¾“å…¥è¯é¢˜æ ‡é¢˜..."
                >
              </div>
              <div class="mb-3">
                <label for="id_content" class="form-label">å†…å®¹</label>
                <textarea
                  class="form-control"
                  id="id_content"
                  name="content"
                  rows="5"
                  required
                  placeholder="è¾“å…¥è¯é¢˜å†…å®¹..."
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
              <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- å¼•å…¥ ECharts -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  {{ universe_data|json_script:"universe-data" }}
  <script>
    // è·å–åç«¯ä¼ æ¥çš„æ•°æ®
    const universeData = JSON.parse(document.getElementById('universe-data').textContent);
    
    // åˆå§‹åŒ– ECharts å®ä¾‹
    const chartDom = document.getElementById('universe');
    const myChart = echarts.init(chartDom, 'dark');
    
    // è®¡ç®—èŠ‚ç‚¹å¤§å°ï¼ˆæ ¹æ®å±‚çº§ï¼‰- å¢å¤§èŠ‚ç‚¹ä½¿å…¶æ›´æ˜æ˜¾
    function getNodeSize(depth) {
      if (depth === 0) return 55;  // è¶…çº§æ ¹èŠ‚ç‚¹
      if (depth === 1) return 40;  // çœŸå®æ ¹èŠ‚ç‚¹
      if (depth === 2) return 28;  // äºŒçº§èŠ‚ç‚¹
      if (depth === 3) return 20;  // ä¸‰çº§èŠ‚ç‚¹
      return 16;  // æ›´æ·±å±‚çº§
    }
    
    // è®¡ç®—èŠ‚ç‚¹é¢œè‰²ï¼ˆæ ¹æ®å±‚çº§ï¼‰- ä½¿ç”¨æ›´é²œè‰³æ˜äº®çš„é¢œè‰²
    function getNodeColor(depth) {
      const colors = [
        '#00ffff',  // è¶…çº§æ ¹èŠ‚ç‚¹ - äº®é’è‰²
        '#9d4edd',  // ä¸€çº§èŠ‚ç‚¹ - äº®ç´«è‰²
        '#ff006e',  // äºŒçº§èŠ‚ç‚¹ - äº®ç²‰è‰²
        '#00d4ff',  // ä¸‰çº§èŠ‚ç‚¹ - å¤©è“è‰²
        '#ff6b9d',  // å››çº§èŠ‚ç‚¹ - ç²‰çº¢è‰²
        '#c77dff',  // äº”çº§èŠ‚ç‚¹ - æ·¡ç´«è‰²
      ];
      return colors[Math.min(depth, colors.length - 1)];
    }
    
    // è®¡ç®—èŠ‚ç‚¹å‘å…‰é¢œè‰²
    function getNodeGlowColor(depth) {
      const color = getNodeColor(depth);
      // æ·»åŠ é€æ˜åº¦
      return color + 'CC';
    }
    
    // è®¡ç®—èŠ‚ç‚¹å†…åœˆé¢œè‰²ï¼ˆæ›´äº®çš„é¢œè‰²ï¼‰
    function getNodeInnerColor(depth) {
      const color = getNodeColor(depth);
      // è½¬æ¢ä¸ºRGBå¹¶å¢åŠ äº®åº¦
      const r = parseInt(color.slice(1, 3), 16);
      const g = parseInt(color.slice(3, 5), 16);
      const b = parseInt(color.slice(5, 7), 16);
      const brightR = Math.min(255, r + 80);
      const brightG = Math.min(255, g + 80);
      const brightB = Math.min(255, b + 80);
      return `rgb(${brightR}, ${brightG}, ${brightB})`;
    }
    
    // é…ç½®é€‰é¡¹
    const option = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'item',
        triggerOn: 'mousemove',
        formatter: function(params) {
          if (params.data.value === 0) {
            return '<div style="padding: 8px;"><b style="font-size: 16px; color: #00ffff;">ğŸŒŒ çŸ¥è¯†å®‡å®™</b><br/><span style="color: #b0b0b0; font-size: 12px;">æ‰€æœ‰çŸ¥è¯†çš„æ ¹æº</span></div>';
          }
          const depth = params.data.depth || 0;
          const color = getNodeColor(depth);
          let html = `<div style="padding: 10px; line-height: 1.8;">`;
          html += `<b style="font-size: 15px; color: ${color}; text-shadow: 0 0 10px ${color};">${params.data.name}</b><br/>`;
          html += `<span style="color: #00ffff;">ğŸ‘¤</span> <span style="color: #b0b0b0;">${params.data.author}</span><br/>`;
          html += `<span style="color: #9d4edd;">ğŸ•</span> <span style="color: #b0b0b0;">${params.data.created_at}</span><br/>`;
          if (params.data.content) {
            html += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0, 255, 255, 0.2); color: #b0b0b0; font-size: 12px;">${params.data.content}</div>`;
          }
          html += `</div>`;
          return html;
        },
        backgroundColor: 'rgba(22, 33, 62, 0.98)',
        borderColor: '#00ffff',
        borderWidth: 2,
        borderRadius: 8,
        padding: 0,
        textStyle: {
          color: '#e0e0e0',
          fontSize: 13
        },
        extraCssText: 'box-shadow: 0 0 20px rgba(0, 255, 255, 0.5), 0 0 40px rgba(157, 78, 221, 0.3); backdrop-filter: blur(10px);'
      },
      series: [
        {
          type: 'tree',
          data: [universeData],
          top: '5%',
          left: '5%',
          bottom: '5%',
          right: '5%',
          symbolSize: function(value, params) {
            return getNodeSize(params.data.depth || 0);
          },
          // ä½¿ç”¨åœ†å½¢ç¬¦å·
          symbol: 'circle',
          label: {
            position: 'left',
            verticalAlign: 'middle',
            align: 'right',
            fontSize: function(params) {
              const depth = params.data.depth || 0;
              if (depth === 0) return 18;
              if (depth === 1) return 16;
              if (depth === 2) return 14;
              return 12;
            },
            color: function(params) {
              const depth = params.data.depth || 0;
              return getNodeColor(depth);
            },
            fontWeight: 'bold',
            formatter: function(params) {
              return params.name;
            },
            textStyle: {
              textShadowBlur: 8,
              textShadowColor: function(params) {
                const depth = params.data.depth || 0;
                return getNodeColor(depth);
              }
            },
            rich: {
              root: {
                fontSize: 20,
                color: '#00ffff',
                fontWeight: 'bold',
                textShadowBlur: 15,
                textShadowColor: '#00ffff'
              }
            }
          },
          leaves: {
            label: {
              position: 'right',
              verticalAlign: 'middle',
              align: 'left'
            }
          },
          emphasis: {
            focus: 'descendant',
            blurScope: 'coordinateSystem',
            itemStyle: {
              color: function(params) {
                const depth = params.data.depth || 0;
                const color = getNodeColor(depth);
                // æ‚¬åœæ—¶ä½¿ç”¨æ›´äº®çš„çº¯è‰²
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                const brightR = Math.min(255, r + 50);
                const brightG = Math.min(255, g + 50);
                const brightB = Math.min(255, b + 50);
                return `rgb(${brightR}, ${brightG}, ${brightB})`;
              },
              shadowBlur: 70,
              shadowColor: function(params) {
                const depth = params.data.depth || 0;
                const color = getNodeColor(depth);
                return color;
              },
              borderWidth: function(params) {
                const depth = params.data.depth || 0;
                return (depth === 0 ? 5 : depth === 1 ? 4 : 3.5);
              },
              borderColor: function(params) {
                // æ‚¬åœæ—¶è¾¹æ¡†ä½¿ç”¨ç™½è‰²
                return '#ffffff';
              },
              opacity: 1
            },
            label: {
              fontSize: function(params) {
                const depth = params.data.depth || 0;
                if (depth === 0) return 22;
                if (depth === 1) return 18;
                if (depth === 2) return 16;
                return 14;
              },
              textStyle: {
                textShadowBlur: 12
              }
            },
            lineStyle: {
              width: function(params) {
                const depth = params.data.depth || 0;
                return (depth === 0 ? 4 : depth === 1 ? 3.5 : 3);
              },
              shadowBlur: 10
            }
          },
          expandAndCollapse: true,
          initialTreeDepth: 1,
          lineStyle: {
            color: function(params) {
              // æ ¹æ®å±‚çº§è°ƒæ•´è¿çº¿é¢œè‰²å’Œé€æ˜åº¦
              const depth = params.data.depth || 0;
              const colors = [
                'rgba(0, 255, 255, 0.6)',   // è¶…çº§æ ¹èŠ‚ç‚¹è¿çº¿
                'rgba(157, 78, 221, 0.5)',  // ä¸€çº§èŠ‚ç‚¹è¿çº¿
                'rgba(255, 0, 110, 0.4)',   // äºŒçº§èŠ‚ç‚¹è¿çº¿
                'rgba(0, 212, 255, 0.35)',  // ä¸‰çº§èŠ‚ç‚¹è¿çº¿
                'rgba(255, 107, 157, 0.3)', // å››çº§èŠ‚ç‚¹è¿çº¿
              ];
              return colors[Math.min(depth, colors.length - 1)];
            },
            width: function(params) {
              const depth = params.data.depth || 0;
              if (depth === 0) return 3;
              if (depth === 1) return 2.5;
              return 2;
            },
            curveness: 0.6,
            type: 'curve',
            shadowBlur: 5,
            shadowColor: 'rgba(0, 255, 255, 0.3)'
          },
          itemStyle: {
            color: function(params) {
              const depth = params.data.depth || 0;
              const color = getNodeColor(depth);
              // ç›´æ¥ä½¿ç”¨çº¯è‰²ï¼Œç¡®ä¿é¢œè‰²æ­£ç¡®æ˜¾ç¤º
              // å¦‚æœæ˜¯è¶…çº§æ ¹èŠ‚ç‚¹ï¼Œä½¿ç”¨æ›´äº®çš„é¢œè‰²
              if (depth === 0) {
                return '#00ffff';
              }
              return color;
            },
            borderColor: function(params) {
              const depth = params.data.depth || 0;
              // è¾¹æ¡†ä½¿ç”¨ç™½è‰²ï¼Œå½¢æˆå¼ºçƒˆå¯¹æ¯”
              return '#ffffff';
            },
            borderWidth: function(params) {
              const depth = params.data.depth || 0;
              if (depth === 0) return 4;
              if (depth === 1) return 3;
              return 2.5;
            },
            shadowBlur: function(params) {
              const depth = params.data.depth || 0;
              if (depth === 0) return 60;
              if (depth === 1) return 45;
              return 35;
            },
            shadowColor: function(params) {
              const depth = params.data.depth || 0;
              const color = getNodeColor(depth);
              // ä½¿ç”¨èŠ‚ç‚¹é¢œè‰²ä½œä¸ºé˜´å½±ï¼Œå¢å¼ºå‘å…‰æ•ˆæœ
              return color;
            },
            shadowOffsetX: 0,
            shadowOffsetY: 0,
            opacity: 1
          },
          // ä½¿ç”¨ radial å¸ƒå±€ï¼ˆæ”¾å°„çŠ¶ï¼‰
          layout: 'radial',
          // å…è®¸æ‹–æ‹½å’Œç¼©æ”¾
          roam: true,
          // åŠ¨ç”»é…ç½®
          animationDuration: 1000,
          animationEasing: 'cubicOut',
          animationDelay: function(idx) {
            return idx * 50;
          }
        }
      ]
    };
    
    // è®¾ç½®é…ç½®é¡¹å¹¶æ¸²æŸ“
    myChart.setOption(option);
    
    // ä½¿ç”¨è‡ªå®šä¹‰æ¸²æŸ“å¢å¼ºèŠ‚ç‚¹è§†è§‰æ•ˆæœ
    myChart.on('rendered', function() {
      // ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ é¢å¤–çš„è§†è§‰æ•ˆæœ
      const graphic = myChart.getDom().querySelectorAll('canvas');
      if (graphic.length > 0) {
        // å›¾è¡¨å·²æ¸²æŸ“ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„DOMå…ƒç´ è£…é¥°
      }
    });
    
    // æ·»åŠ åŠ è½½å®Œæˆæç¤º
    setTimeout(function() {
      const title = document.querySelector('h1');
      if (title) {
        title.style.transition = 'opacity 0.5s ease';
        title.style.opacity = '0.9';
      }
    }, 500);
    
    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', function() {
      myChart.resize();
    });
    
    // ç‚¹å‡»èŠ‚ç‚¹è·³è½¬åˆ°è¯¦æƒ…é¡µ
    myChart.on('click', function(params) {
      if (params.data.value && params.data.value !== 0) {
        // æ·»åŠ ç‚¹å‡»åé¦ˆ
        params.event.event.stopPropagation();
        window.location.href = '/node/' + params.data.value + '/';
      }
    });
    
    // æ·»åŠ é¼ æ ‡æ‚¬åœæ—¶çš„å…‰æ ‡æ ·å¼
    chartDom.style.cursor = 'default';
    myChart.on('mouseover', function(params) {
      if (params.data.value && params.data.value !== 0) {
        chartDom.style.cursor = 'pointer';
      }
    });
    myChart.on('mouseout', function() {
      chartDom.style.cursor = 'default';
    });
  </script>
{% endblock %}
